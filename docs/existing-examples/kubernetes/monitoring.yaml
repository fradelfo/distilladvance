# Kubernetes Monitoring Configuration
# Prometheus rules, Grafana dashboards, and alerting configuration

# === PROMETHEUS RULES ===
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: blog-api-rules
  namespace: blog-system
  labels:
    app.kubernetes.io/name: blog-api
    app.kubernetes.io/component: monitoring
    prometheus: blog-system
spec:
  groups:
  - name: blog-api.rules
    interval: 30s
    rules:
    # Application Health Rules
    - alert: BlogAPIDown
      expr: up{job="blog-api"} == 0
      for: 5m
      labels:
        severity: critical
        service: blog-api
        team: backend
      annotations:
        summary: "Blog API is down"
        description: "Blog API has been down for more than 5 minutes. Instance: {{ $labels.instance }}"

    - alert: BlogAPIHighResponseTime
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="blog-api"}[5m])) > 1
      for: 10m
      labels:
        severity: warning
        service: blog-api
        team: backend
      annotations:
        summary: "Blog API high response time"
        description: "95th percentile response time is {{ $value }}s for instance {{ $labels.instance }}"

    - alert: BlogAPIHighErrorRate
      expr: rate(http_requests_total{job="blog-api",status=~"5.."}[5m]) / rate(http_requests_total{job="blog-api"}[5m]) > 0.05
      for: 5m
      labels:
        severity: critical
        service: blog-api
        team: backend
      annotations:
        summary: "Blog API high error rate"
        description: "Error rate is {{ $value | humanizePercentage }} for instance {{ $labels.instance }}"

    - alert: BlogAPIHighMemoryUsage
      expr: (container_memory_usage_bytes{pod=~"blog-api-.*"} / container_spec_memory_limit_bytes{pod=~"blog-api-.*"}) > 0.85
      for: 15m
      labels:
        severity: warning
        service: blog-api
        team: backend
      annotations:
        summary: "Blog API high memory usage"
        description: "Memory usage is {{ $value | humanizePercentage }} for pod {{ $labels.pod }}"

    - alert: BlogAPIHighCPUUsage
      expr: rate(container_cpu_usage_seconds_total{pod=~"blog-api-.*"}[5m]) / (container_spec_cpu_quota{pod=~"blog-api-.*"} / container_spec_cpu_period{pod=~"blog-api-.*"}) > 0.8
      for: 15m
      labels:
        severity: warning
        service: blog-api
        team: backend
      annotations:
        summary: "Blog API high CPU usage"
        description: "CPU usage is {{ $value | humanizePercentage }} for pod {{ $labels.pod }}"

  - name: database.rules
    interval: 30s
    rules:
    # Database Health Rules
    - alert: PostgreSQLDown
      expr: pg_up{job="postgres"} == 0
      for: 5m
      labels:
        severity: critical
        service: postgres
        team: infrastructure
      annotations:
        summary: "PostgreSQL is down"
        description: "PostgreSQL database has been down for more than 5 minutes. Instance: {{ $labels.instance }}"

    - alert: PostgreSQLTooManyConnections
      expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
      for: 5m
      labels:
        severity: warning
        service: postgres
        team: infrastructure
      annotations:
        summary: "PostgreSQL too many connections"
        description: "PostgreSQL has {{ $value | humanizePercentage }} connections used. Instance: {{ $labels.instance }}"

    - alert: PostgreSQLSlowQueries
      expr: pg_stat_statements_mean_time_ms > 1000
      for: 10m
      labels:
        severity: warning
        service: postgres
        team: infrastructure
      annotations:
        summary: "PostgreSQL slow queries detected"
        description: "Average query time is {{ $value }}ms for database {{ $labels.datname }}"

    - alert: PostgreSQLHighDiskUsage
      expr: (pg_database_size_bytes / pg_filesystem_size_bytes) > 0.85
      for: 5m
      labels:
        severity: warning
        service: postgres
        team: infrastructure
      annotations:
        summary: "PostgreSQL high disk usage"
        description: "Disk usage is {{ $value | humanizePercentage }} for database {{ $labels.datname }}"

  - name: redis.rules
    interval: 30s
    rules:
    # Redis Health Rules
    - alert: RedisDown
      expr: redis_up{job="redis"} == 0
      for: 5m
      labels:
        severity: critical
        service: redis
        team: infrastructure
      annotations:
        summary: "Redis is down"
        description: "Redis instance has been down for more than 5 minutes. Instance: {{ $labels.instance }}"

    - alert: RedisHighMemoryUsage
      expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
      for: 10m
      labels:
        severity: warning
        service: redis
        team: infrastructure
      annotations:
        summary: "Redis high memory usage"
        description: "Memory usage is {{ $value | humanizePercentage }} for instance {{ $labels.instance }}"

    - alert: RedisHighConnections
      expr: redis_connected_clients > 100
      for: 10m
      labels:
        severity: warning
        service: redis
        team: infrastructure
      annotations:
        summary: "Redis high number of connections"
        description: "{{ $value }} connections to Redis instance {{ $labels.instance }}"

  - name: kubernetes.rules
    interval: 30s
    rules:
    # Kubernetes Cluster Rules
    - alert: KubernetesPodCrashLooping
      expr: rate(kube_pod_container_status_restarts_total{namespace="blog-system"}[15m]) * 60 * 15 > 5
      for: 5m
      labels:
        severity: warning
        service: kubernetes
        team: infrastructure
      annotations:
        summary: "Pod is crash looping"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crash looping"

    - alert: KubernetesPodNotReady
      expr: kube_pod_status_ready{condition="false",namespace="blog-system"} == 1
      for: 10m
      labels:
        severity: warning
        service: kubernetes
        team: infrastructure
      annotations:
        summary: "Pod not ready"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been not ready for more than 10 minutes"

    - alert: KubernetesHPAScaleUp
      expr: kube_hpa_status_current_replicas{namespace="blog-system"} != kube_hpa_status_desired_replicas{namespace="blog-system"}
      for: 15m
      labels:
        severity: info
        service: kubernetes
        team: infrastructure
      annotations:
        summary: "HPA scaling event"
        description: "HPA {{ $labels.hpa }} in namespace {{ $labels.namespace }} is scaling. Current: {{ $labels.current_replicas }}, Desired: {{ $labels.desired_replicas }}"

---
# === GRAFANA DASHBOARD CONFIGMAP ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: blog-system
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: dashboards
data:
  blog-api-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Blog API Dashboard",
        "description": "Comprehensive monitoring for Blog API application",
        "tags": ["blog", "api", "application"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{job=\"blog-api\"}[5m])",
                "legendFormat": "{{ method }} {{ status }}"
              }
            ],
            "yAxes": [
              {
                "label": "requests/sec",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Response Time P95",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=\"blog-api\"}[5m]))",
                "legendFormat": "95th percentile"
              },
              {
                "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket{job=\"blog-api\"}[5m]))",
                "legendFormat": "50th percentile"
              }
            ],
            "yAxes": [
              {
                "label": "seconds",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "Error Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{job=\"blog-api\",status=~\"5..\"}[5m]) / rate(http_requests_total{job=\"blog-api\"}[5m])",
                "legendFormat": "Error Rate"
              }
            ],
            "yAxes": [
              {
                "label": "percentage",
                "min": 0,
                "max": 1
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "container_memory_usage_bytes{pod=~\"blog-api-.*\"} / 1024 / 1024",
                "legendFormat": "{{ pod }}"
              }
            ],
            "yAxes": [
              {
                "label": "MB",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          },
          {
            "id": 5,
            "title": "CPU Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{pod=~\"blog-api-.*\"}[5m]) * 100",
                "legendFormat": "{{ pod }}"
              }
            ],
            "yAxes": [
              {
                "label": "percentage",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16}
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }

  database-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Database Dashboard",
        "description": "PostgreSQL and Redis monitoring",
        "tags": ["database", "postgresql", "redis"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "PostgreSQL Connections",
            "type": "graph",
            "targets": [
              {
                "expr": "pg_stat_database_numbackends",
                "legendFormat": "{{ datname }}"
              }
            ],
            "yAxes": [
              {
                "label": "connections",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "PostgreSQL Query Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(pg_stat_database_xact_commit[5m]) + rate(pg_stat_database_xact_rollback[5m])",
                "legendFormat": "{{ datname }}"
              }
            ],
            "yAxes": [
              {
                "label": "queries/sec",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "Redis Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "redis_memory_used_bytes / 1024 / 1024",
                "legendFormat": "Used Memory"
              },
              {
                "expr": "redis_memory_max_bytes / 1024 / 1024",
                "legendFormat": "Max Memory"
              }
            ],
            "yAxes": [
              {
                "label": "MB",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Redis Operations Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(redis_commands_total[5m])",
                "legendFormat": "{{ cmd }}"
              }
            ],
            "yAxes": [
              {
                "label": "ops/sec",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }

  kubernetes-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Kubernetes Dashboard",
        "description": "Kubernetes cluster monitoring",
        "tags": ["kubernetes", "cluster", "infrastructure"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Pod Status",
            "type": "table",
            "targets": [
              {
                "expr": "kube_pod_status_phase{namespace=\"blog-system\"}",
                "format": "table"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "CPU Usage by Pod",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{namespace=\"blog-system\"}[5m]) * 100",
                "legendFormat": "{{ pod }}"
              }
            ],
            "yAxes": [
              {
                "label": "percentage",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "Memory Usage by Pod",
            "type": "graph",
            "targets": [
              {
                "expr": "container_memory_usage_bytes{namespace=\"blog-system\"} / 1024 / 1024",
                "legendFormat": "{{ pod }}"
              }
            ],
            "yAxes": [
              {
                "label": "MB",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Network I/O",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(container_network_receive_bytes_total{namespace=\"blog-system\"}[5m]) / 1024",
                "legendFormat": "{{ pod }} - received"
              },
              {
                "expr": "rate(container_network_transmit_bytes_total{namespace=\"blog-system\"}[5m]) / 1024",
                "legendFormat": "{{ pod }} - transmitted"
              }
            ],
            "yAxes": [
              {
                "label": "KB/s",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }

---
# === GRAFANA DATASOURCES CONFIGMAP ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: blog-system
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: datasources
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus-service:9090
      isDefault: true
      editable: true
      jsonData:
        httpMethod: POST
        queryTimeout: 300s
        timeInterval: 30s
    - name: Loki
      type: loki
      access: proxy
      url: http://loki:3100
      editable: true
      jsonData:
        maxLines: 1000

---
# === GRAFANA PROVISIONING CONFIGMAP ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-provisioning
  namespace: blog-system
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: provisioning
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: 'default'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /etc/grafana/provisioning/dashboards

  notifiers.yaml: |
    apiVersion: 1
    notifiers:
    - name: slack
      type: slack
      uid: slack-notifier
      org_id: 1
      is_default: true
      send_reminder: true
      frequency: 10m
      settings:
        url: https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK
        title: Grafana Alert
        text: "{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}"
        username: Grafana

---
# === PROMETHEUS ADAPTER CONFIG ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: adapter-config
  namespace: blog-system
  labels:
    app.kubernetes.io/name: prometheus-adapter
    app.kubernetes.io/component: config
data:
  config.yaml: |
    rules:
    - seriesQuery: 'http_requests_total{namespace!="",pod!=""}'
      seriesFilters: []
      resources:
        overrides:
          namespace:
            resource: namespace
          pod:
            resource: pod
      name:
        matches: "^http_requests_total"
        as: "requests_per_second"
      metricsQuery: 'rate(<<.Series>>{<<.LabelMatchers>>}[2m])'

    - seriesQuery: 'http_request_duration_seconds{namespace!="",pod!=""}'
      seriesFilters: []
      resources:
        overrides:
          namespace:
            resource: namespace
          pod:
            resource: pod
      name:
        matches: "^http_request_duration_seconds"
        as: "response_time_p99"
      metricsQuery: 'histogram_quantile(0.99, rate(<<.Series>>_bucket{<<.LabelMatchers>>}[2m]))'

    - seriesQuery: 'nginx_ingress_controller_requests{namespace!="",pod!=""}'
      seriesFilters: []
      resources:
        overrides:
          namespace:
            resource: namespace
          pod:
            resource: pod
      name:
        matches: "^nginx_ingress_controller_requests"
        as: "nginx_ingress_controller_requests_rate"
      metricsQuery: 'rate(<<.Series>>{<<.LabelMatchers>>}[2m])'

    resourceRules:
      cpu:
        containerQuery: sum(rate(container_cpu_usage_seconds_total{<<.LabelMatchers>>,container!="POD",container!=""}[3m])) by (<<.GroupBy>>)
        nodeQuery: sum(rate(container_cpu_usage_seconds_total{<<.LabelMatchers>>,id='/'}[3m])) by (<<.GroupBy>>)
        resources:
          overrides:
            node:
              resource: node
            namespace:
              resource: namespace
            pod:
              resource: pod
        containerLabel: container
      memory:
        containerQuery: sum(container_memory_working_set_bytes{<<.LabelMatchers>>,container!="POD",container!=""}) by (<<.GroupBy>>)
        nodeQuery: sum(container_memory_working_set_bytes{<<.LabelMatchers>>,id='/'}) by (<<.GroupBy>>)
        resources:
          overrides:
            node:
              resource: node
            namespace:
              resource: namespace
            pod:
              resource: pod
        containerLabel: container
      window: 3m

---
# === ALERTMANAGER CONFIGURATION ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: blog-system
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/component: config
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'localhost:587'
      smtp_from: 'alerts@blog.example.com'
      slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

    route:
      group_by: ['alertname', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 24h
      receiver: 'default'
      routes:
      - match:
          severity: critical
        receiver: 'critical-alerts'
      - match:
          team: infrastructure
        receiver: 'infrastructure-team'
      - match:
          team: backend
        receiver: 'backend-team'

    receivers:
    - name: 'default'
      slack_configs:
      - channel: '#alerts'
        title: 'Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
        send_resolved: true

    - name: 'critical-alerts'
      slack_configs:
      - channel: '#critical-alerts'
        title: 'CRITICAL: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
        send_resolved: true
      email_configs:
      - to: 'oncall@blog.example.com'
        subject: 'CRITICAL Alert: {{ .GroupLabels.alertname }}'
        body: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'

    - name: 'infrastructure-team'
      slack_configs:
      - channel: '#infrastructure'
        title: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'

    - name: 'backend-team'
      slack_configs:
      - channel: '#backend'
        title: 'Backend Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'

    inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'service']

---
# === PROMETHEUS CONFIGURATION ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: blog-system
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: config
data:
  prometheus.yml: |
    global:
      scrape_interval: 30s
      evaluation_interval: 30s
      scrape_timeout: 10s
      external_labels:
        cluster: 'blog-system'
        environment: 'production'

    rule_files:
    - "/etc/prometheus/rules/*.yml"

    alerting:
      alertmanagers:
      - static_configs:
        - targets: ['alertmanager:9093']

    scrape_configs:
    - job_name: 'prometheus'
      static_configs:
      - targets: ['localhost:9090']

    - job_name: 'blog-api'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names: ['blog-system']
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: blog-api-service
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: metrics

    - job_name: 'nginx'
      kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names: ['blog-system']
      relabel_configs:
      - source_labels: [__meta_kubernetes_service_name]
        action: keep
        regex: nginx-service
      - source_labels: [__meta_kubernetes_endpoint_port_name]
        action: keep
        regex: metrics

    - job_name: 'postgres'
      static_configs:
      - targets: ['postgres-exporter:9187']

    - job_name: 'redis'
      static_configs:
      - targets: ['redis-exporter:9121']

    - job_name: 'kubernetes-apiservers'
      kubernetes_sd_configs:
      - role: endpoints
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https

    - job_name: 'kubernetes-nodes'
      kubernetes_sd_configs:
      - role: node
      scheme: https
      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)

    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['blog-system']
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name