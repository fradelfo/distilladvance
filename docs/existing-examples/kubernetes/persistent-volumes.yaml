# Kubernetes Persistent Volumes for Blog API
# Provides persistent storage for database, Redis, and application data

# === STORAGE CLASSES ===
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
  labels:
    app.kubernetes.io/name: blog-api
    app.kubernetes.io/component: storage
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  fsType: ext4
  encrypted: "true"
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Delete

---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard-hdd
  labels:
    app.kubernetes.io/name: blog-api
    app.kubernetes.io/component: storage
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
  fsType: ext4
  encrypted: "true"
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Retain

---
# === POSTGRESQL PERSISTENT VOLUME CLAIM ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: blog-system
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/version: "16"
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 50Gi
    limits:
      storage: 100Gi
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres

---
# === REDIS PERSISTENT VOLUME CLAIM ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: blog-system
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 10Gi
    limits:
      storage: 20Gi
  selector:
    matchLabels:
      app.kubernetes.io/name: redis

---
# === APPLICATION UPLOADS PERSISTENT VOLUME CLAIM ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-uploads-pvc
  namespace: blog-system
  labels:
    app.kubernetes.io/name: blog-api
    app.kubernetes.io/component: uploads
spec:
  accessModes:
    - ReadWriteMany  # Multiple pods can read/write
  storageClassName: standard-hdd
  resources:
    requests:
      storage: 100Gi
    limits:
      storage: 500Gi

---
# === APPLICATION LOGS PERSISTENT VOLUME CLAIM ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-logs-pvc
  namespace: blog-system
  labels:
    app.kubernetes.io/name: blog-api
    app.kubernetes.io/component: logs
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: standard-hdd
  resources:
    requests:
      storage: 20Gi
    limits:
      storage: 50Gi

---
# === PROMETHEUS DATA PERSISTENT VOLUME CLAIM ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-pvc
  namespace: blog-system
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 50Gi
    limits:
      storage: 100Gi

---
# === GRAFANA DATA PERSISTENT VOLUME CLAIM ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
  namespace: blog-system
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: standard-hdd
  resources:
    requests:
      storage: 10Gi
    limits:
      storage: 20Gi

---
# === ELASTICSEARCH DATA PERSISTENT VOLUME CLAIM ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: elasticsearch-pvc
  namespace: blog-system
  labels:
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/component: logging
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 100Gi
    limits:
      storage: 200Gi

---
# === LOCAL PERSISTENT VOLUMES (for on-premises) ===
# PostgreSQL Local PV
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-local-pv
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
spec:
  capacity:
    storage: 50Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /mnt/postgres-data
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-node-1

---
# Redis Local PV
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-local-pv
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /mnt/redis-data
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-node-1

---
# === VOLUME SNAPSHOTS FOR BACKUPS ===
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: postgres-snapshot-class
  labels:
    app.kubernetes.io/name: blog-api
    app.kubernetes.io/component: backup
driver: ebs.csi.aws.com
deletionPolicy: Retain
parameters:
  tagSpecification_1: "Name=postgres-backup"
  tagSpecification_2: "Environment=production"

---
# Scheduled Volume Snapshot for PostgreSQL
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: postgres-backup
  namespace: blog-system
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: backup
spec:
  volumeSnapshotClassName: postgres-snapshot-class
  source:
    persistentVolumeClaimName: postgres-pvc

---
# === BACKUP CRONJOB FOR VOLUME SNAPSHOTS ===
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup-cronjob
  namespace: blog-system
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: backup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  timeZone: "UTC"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: postgres-backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: bitnami/kubectl:latest
            command:
            - /bin/sh
            - -c
            - |
              SNAPSHOT_NAME="postgres-backup-$(date +%Y%m%d-%H%M%S)"
              cat <<EOF | kubectl apply -f -
              apiVersion: snapshot.storage.k8s.io/v1
              kind: VolumeSnapshot
              metadata:
                name: $SNAPSHOT_NAME
                namespace: blog-system
                labels:
                  app.kubernetes.io/name: postgres
                  app.kubernetes.io/component: backup
                  backup-type: scheduled
              spec:
                volumeSnapshotClassName: postgres-snapshot-class
                source:
                  persistentVolumeClaimName: postgres-pvc
              EOF
              echo "Created volume snapshot: $SNAPSHOT_NAME"
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"